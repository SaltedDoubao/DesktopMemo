<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="DesktopMemo 数据流和通信机制，展示 MVVM 模式下的数据流向和模块间通信。">
    <title>数据流和通信机制 - DesktopMemo Docs</title>

    <script src="../theme-preload.js"></script>
    <link rel="stylesheet" href="../styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>

<body>
    <div class="layout">
        <nav class="sidebar">
            <div class="sidebar-logo">DesktopMemo</div>

            <h3>概览</h3>
            <ul>
                <li><a href="../index.html">首页</a></li>
                <li><a href="../contributing.html">贡献指南</a></li>
                <li><a href="../mysql_integration.html">MySQL 集成规范</a></li>
            </ul>

            <h3>项目架构</h3>
            <ul>
                <li><a href="index.html">架构首页</a></li>
                <li><a href="architecture.html">01 架构图</a></li>
                <li><a href="modules.html">02 模块划分</a></li>
                <li><a href="tech_stack.html">03 技术栈和依赖</a></li>
                <li><a href="data_flow.html" class="active">04 数据流和通信</a></li>
            </ul>

            <h3>API 文档</h3>
            <ul>
                <li><a href="../api/index.html">API 概览</a></li>
            </ul>
        </nav>

        <main class="content">
            <div class="content-inner">
                <h1>DesktopMemo 数据流和通信机制</h1>

                <h2>1. 数据流总览</h2>
                <div class="mermaid">
                    graph TB
                    subgraph "用户交互层"
                    User[用户操作]
                    UI[WPF UI Views]
                    end

                    subgraph "应用逻辑层"
                    VM[ViewModels]
                    Commands[Commands]
                    end

                    subgraph "业务服务层"
                    Repos[Repositories]
                    Services[Services]
                    end

                    subgraph "数据持久层"
                    FS[File System]
                    DB[(SQLite)]
                    Settings[JSON Files]
                    end

                    User -->|点击/输入| UI
                    UI -->|数据绑定| VM
                    UI -->|触发命令| Commands
                    Commands -->|调用方法| VM
                    VM -->|读写数据| Repos
                    VM -->|业务逻辑| Services
                    Repos -->|持久化| FS
                    Repos -->|索引查询| DB
                    Services -->|配置| Settings

                    DB -.通知.-> Repos
                    Repos -.更新.-> VM
                    VM -.属性通知.-> UI
                    UI -.渲染.-> User

                    style User fill:#fff9c4
                    style UI fill:#e3f2fd
                    style VM fill:#f3e5f5
                    style Repos fill:#e8f5e9
                    style DB fill:#c8e6c9
                </div>

                <h2>2. 核心数据流场景</h2>

                <h3>2.1 应用启动流程</h3>
                <div class="mermaid">
                    sequenceDiagram
                    participant User
                    participant App as App.xaml.cs
                    participant DI as DI Container
                    participant Migration as Migration Services
                    participant VM as MainViewModel
                    participant Repo as Repositories
                    participant UI as MainWindow

                    User->>App: 启动应用
                    App->>DI: 配置服务 (ConfigureServices)
                    DI->>DI: 注册 Repositories
                    DI->>DI: 注册 Services
                    DI->>DI: 注册 ViewModels

                    App->>Migration: 执行数据迁移
                    Migration->>Migration: TodoMigrationService (JSON→SQLite)
                    Migration->>Migration: MemoMetadataMigrationService
                    Migration-->>App: 迁移完成

                    App->>DI: 解析 MainViewModel
                    DI->>VM: 创建实例 (注入依赖)
                    App->>VM: InitializeAsync()

                    VM->>Repo: GetAllAsync() - 加载备忘录
                    Repo-->>VM: 返回 List of Memo
                    VM->>VM: 填充 Memos 集合

                    App->>UI: 创建 MainWindow
                    UI->>UI: 数据绑定到 ViewModel
                    App->>UI: window.Show()
                    UI-->>User: 显示界面
                </div>

                <h3>2.2 创建新备忘录流程</h3>
                <div class="mermaid">
                    sequenceDiagram
                    participant User
                    participant UI as MainWindow
                    participant VM as MainViewModel
                    participant Repo as SqliteIndexedMemoRepository
                    participant FS as File System
                    participant DB as SQLite Database

                    User->>UI: 点击 "新建备忘录"
                    UI->>VM: CreateMemoCommand.Execute()

                    VM->>VM: Memo.CreateNew(title, content)
                    VM->>Repo: AddAsync(newMemo)

                    Repo->>FS: 写入 Markdown 文件
                    Note over FS: .memodata/memos/{id}.md
                    FS-->>Repo: 写入成功

                    Repo->>DB: INSERT INTO memos
                    DB-->>Repo: 插入成功

                    Repo-->>VM: 返回成功
                    VM->>VM: Memos.Insert(0, newMemo)
                    VM->>VM: SelectedMemo = newMemo
                    VM->>VM: IsEditMode = true

                    VM-->>UI: 属性变更通知
                    UI->>UI: 刷新备忘录列表
                    UI->>UI: 激活编辑器
                    UI-->>User: 显示新备忘录
                </div>

                <h3>2.3 编辑备忘录流程</h3>
                <p><strong>关键点</strong>: 防抖策略 (500ms), 仅保存修改。</p>

                <h3>2.4 搜索备忘录流程</h3>
                <p><strong>策略</strong>: 全量加载 + 内存过滤。</p>

                <h2>3. 数据存储策略</h2>

                <h3>3.1 备忘录双存储设计</h3>
                <div class="mermaid">
                    graph LR
                    subgraph "内存"
                    Memo[Memo 对象]
                    end

                    subgraph "持久化"
                    MD[Markdown 文件<br />完整内容]
                    DB[SQLite 索引<br />元数据]
                    end

                    Memo -->|序列化| MD
                    Memo -->|提取元数据| DB

                    MD -.加载.-> Memo
                    DB -.快速查询.-> Memo

                    style Memo fill:#f3e5f5
                    style MD fill:#ffe0b2
                    style DB fill:#c8e6c9
                </div>

                <h2>6. 数据流中的关键设计模式</h2>
                <ul>
                    <li><strong>Repository 模式</strong>: 封装数据访问。</li>
                    <li><strong>单向数据流</strong>: 数据流向清晰。</li>
                    <li><strong>防抖模式 (Debounce)</strong>: 减少高频操作。</li>
                </ul>

                <h2>11. 总结</h2>
                <h3>核心数据流路径</h3>
                <ol>
                    <li><strong>用户输入</strong> → UI</li>
                    <li><strong>UI</strong> → ViewModel</li>
                    <li><strong>ViewModel</strong> → Repository/Service</li>
                    <li><strong>Repository</strong> → File System/SQLite</li>
                    <li><strong>持久化成功</strong> → ViewModel</li>
                    <li><strong>ViewModel</strong> → UI</li>
                    <li><strong>UI</strong> → 用户</li>
                </ol>

                <hr>
                <p><strong>最后更新</strong>: 2025-11-15</p>

            </div>
        </main>
    </div>

    <script src="../main.js"></script>
</body>

</html>