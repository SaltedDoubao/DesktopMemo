<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="DesktopMemo æœåŠ¡æ¥å£ API æ–‡æ¡£ - ISettingsService, IWindowService, ITrayService, ILocalizationService">
    <title>æœåŠ¡æ¥å£ - DesktopMemo Docs</title>
    
    <script src="../theme-preload.js"></script>
    <link rel="stylesheet" href="../styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="layout">
        <nav class="sidebar">
            <div class="sidebar-logo">DesktopMemo</div>

            <h3>æ¦‚è§ˆ</h3>
            <ul>
                <li><a href="../index.html">é¦–é¡µ</a></li>
                <li><a href="../contributing.html">è´¡çŒ®æŒ‡å—</a></li>
                <li><a href="../mysql_integration.html">MySQL é›†æˆè§„èŒƒ</a></li>
            </ul>

            <h3>é¡¹ç›®æ¶æ„</h3>
            <ul>
                <li><a href="../project_structure/index.html">æ¶æ„é¦–é¡µ</a></li>
                <li><a href="../project_structure/architecture.html">01 æ¶æ„å›¾</a></li>
                <li><a href="../project_structure/modules.html">02 æ¨¡å—åˆ’åˆ†</a></li>
                <li><a href="../project_structure/tech_stack.html">03 æŠ€æœ¯æ ˆå’Œä¾èµ–</a></li>
                <li><a href="../project_structure/data_flow.html">04 æ•°æ®æµå’Œé€šä¿¡</a></li>
            </ul>

            <h3>API æ–‡æ¡£</h3>
            <ul>
                <li><a href="index.html">API æ¦‚è§ˆ</a></li>
                <li><a href="repositories.html">ä»“å‚¨æ¥å£</a></li>
                <li><a href="services.html" class="active">æœåŠ¡æ¥å£</a></li>
                <li><a href="models.html">é¢†åŸŸæ¨¡å‹</a></li>
                <li><a href="enums.html">æšä¸¾ç±»å‹</a></li>
            </ul>
        </nav>

        <main class="content">
            <div class="content-inner">
                <h1>æœåŠ¡æ¥å£æ–‡æ¡£</h1>
                <p>æœåŠ¡æ¥å£æä¾›ä¸šåŠ¡é€»è¾‘å’Œç³»ç»ŸåŠŸèƒ½ï¼ŒåŒ…æ‹¬è®¾ç½®ç®¡ç†ã€æœç´¢ã€çª—å£ç®¡ç†ã€æ‰˜ç›˜æœåŠ¡å’Œæœ¬åœ°åŒ–ç­‰ã€‚</p>

                <!-- ISettingsService -->
                <h2 id="isettingsservice">ISettingsService</h2>
                <p>åº”ç”¨è®¾ç½®ç®¡ç†æœåŠ¡ï¼Œæä¾›è®¾ç½®çš„åŠ è½½å’Œä¿å­˜åŠŸèƒ½ã€‚</p>

                <h3>æ¥å£å®šä¹‰</h3>
                <pre><code class="language-csharp">namespace DesktopMemo.Core.Contracts;

/// &lt;summary&gt;
/// æä¾›åº”ç”¨è®¾ç½®çš„åŠ è½½ä¸ä¿å­˜æ¥å£ã€‚
/// &lt;/summary&gt;
public interface ISettingsService
{
    Task&lt;WindowSettings&gt; LoadAsync(CancellationToken cancellationToken = default);
    Task SaveAsync(WindowSettings settings, CancellationToken cancellationToken = default);
}</code></pre>

                <h3>æ–¹æ³•è¯¦æƒ…</h3>

                <h4>LoadAsync</h4>
                <p>åŠ è½½åº”ç”¨è®¾ç½®ã€‚</p>
                <pre><code class="language-csharp">Task&lt;WindowSettings&gt; LoadAsync(CancellationToken cancellationToken = default)</code></pre>

                <p><strong>è¿”å›å€¼</strong>ï¼šåŠ è½½çš„è®¾ç½®å¯¹è±¡ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™è¿”å› <code>WindowSettings.Default</code></p>

                <pre><code class="language-csharp">var settings = await _settingsService.LoadAsync();
Console.WriteLine($"çª—å£å¤§å°: {settings.Width}x{settings.Height}");
Console.WriteLine($"é€æ˜åº¦: {settings.Transparency}");</code></pre>

                <blockquote>
                    <p><strong>ğŸ’¡ æ³¨æ„</strong>ï¼šå¦‚æœè®¾ç½®æ–‡ä»¶æŸåï¼Œä¼šå°è¯•ä»å¤‡ä»½æ¢å¤ã€‚åŠ è½½å¤±è´¥æ—¶è®°å½•é”™è¯¯æ—¥å¿—å¹¶è¿”å›é»˜è®¤è®¾ç½®ã€‚</p>
                </blockquote>

                <h4>SaveAsync</h4>
                <p>ä¿å­˜åº”ç”¨è®¾ç½®ã€‚</p>
                <pre><code class="language-csharp">Task SaveAsync(WindowSettings settings, CancellationToken cancellationToken = default)</code></pre>

                <pre><code class="language-csharp">var newSettings = currentSettings.WithSize(1200, 800);
await _settingsService.SaveAsync(newSettings);</code></pre>

                <p><strong>ç‰¹æ€§</strong>ï¼š</p>
                <ul>
                    <li>é‡‡ç”¨åŸå­æ€§ä¿å­˜ï¼šå…ˆå†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼ŒæˆåŠŸåæ›¿æ¢åŸæ–‡ä»¶</li>
                    <li>ä¿å­˜å‰ä¼šåˆ›å»ºå¤‡ä»½æ–‡ä»¶</li>
                    <li>ä½¿ç”¨ JSON æ ¼å¼å­˜å‚¨</li>
                </ul>

                <p><strong>ä¿å­˜ä½ç½®</strong>ï¼š</p>
                <ul>
                    <li>ä¸»æ–‡ä»¶ï¼š<code>.memodata/settings.json</code></li>
                    <li>å¤‡ä»½æ–‡ä»¶ï¼š<code>.memodata/settings.json.backup</code></li>
                </ul>

                <h3>æœ€ä½³å®è·µï¼šåŸå­æ€§æ›´æ–°</h3>
                <pre><code class="language-csharp">// âœ… æ­£ç¡® - åŸå­æ€§ä¿å­˜
try
{
    var newSettings = currentSettings with { Transparency = 0.2 };
    await _settingsService.SaveAsync(newSettings); // å…ˆä¿å­˜åˆ°æ–‡ä»¶
    CurrentSettings = newSettings; // ä¿å­˜æˆåŠŸåæ‰æ›´æ–°å†…å­˜
}
catch (Exception ex)
{
    // ä¿å­˜å¤±è´¥ï¼Œå†…å­˜çŠ¶æ€ä¿æŒä¸å˜
    Debug.WriteLine($"è®¾ç½®ä¿å­˜å¤±è´¥: {ex}");
}

// âŒ é”™è¯¯ - å…ˆæ›´æ–°å†…å­˜ï¼Œå¯èƒ½å¯¼è‡´ä¸ä¸€è‡´
CurrentSettings = newSettings;
await _settingsService.SaveAsync(newSettings);</code></pre>

                <!-- IMemoSearchService -->
                <h2 id="imemosearchservice">IMemoSearchService</h2>
                <p>å¤‡å¿˜å½•æœç´¢æœåŠ¡ï¼Œæä¾›æ–‡æœ¬æœç´¢å’Œæ›¿æ¢åŠŸèƒ½ã€‚</p>

                <h3>æ¥å£å®šä¹‰</h3>
                <pre><code class="language-csharp">public interface IMemoSearchService
{
    IEnumerable&lt;SearchMatch&gt; FindMatches(string text, string keyword,
        bool caseSensitive = false, bool useRegex = false);

    string Replace(string text, string keyword, string replacement,
        bool caseSensitive = false, bool useRegex = false);
}

public sealed record SearchMatch(int Index, int Length);</code></pre>

                <h3>æ–¹æ³•è¯¦æƒ…</h3>

                <h4>FindMatches</h4>
                <p>åœ¨æ–‡æœ¬ä¸­æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…é¡¹ã€‚</p>

                <table>
                    <thead>
                        <tr>
                            <th>å‚æ•°</th>
                            <th>ç±»å‹</th>
                            <th>è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>text</td>
                            <td><code>string</code></td>
                            <td>è¦æœç´¢çš„æ–‡æœ¬</td>
                        </tr>
                        <tr>
                            <td>keyword</td>
                            <td><code>string</code></td>
                            <td>æœç´¢å…³é”®è¯æˆ–æ­£åˆ™è¡¨è¾¾å¼</td>
                        </tr>
                        <tr>
                            <td>caseSensitive</td>
                            <td><code>bool</code></td>
                            <td>æ˜¯å¦åŒºåˆ†å¤§å°å†™ï¼ˆé»˜è®¤ï¼šfalseï¼‰</td>
                        </tr>
                        <tr>
                            <td>useRegex</td>
                            <td><code>bool</code></td>
                            <td>æ˜¯å¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼ˆé»˜è®¤ï¼šfalseï¼‰</td>
                        </tr>
                    </tbody>
                </table>

                <pre><code class="language-csharp">var text = "Hello World, hello universe";
var matches = _searchService.FindMatches(text, "hello", caseSensitive: false);

foreach (var match in matches)
{
    Console.WriteLine($"æ‰¾åˆ°åŒ¹é…: ä½ç½®={match.Index}, é•¿åº¦={match.Length}");
}
// è¾“å‡º:
// æ‰¾åˆ°åŒ¹é…: ä½ç½®=0, é•¿åº¦=5
// æ‰¾åˆ°åŒ¹é…: ä½ç½®=13, é•¿åº¦=5</code></pre>

                <h4>æ­£åˆ™è¡¨è¾¾å¼ç¤ºä¾‹</h4>
                <pre><code class="language-csharp">// æŸ¥æ‰¾æ‰€æœ‰é‚®ç®±åœ°å€
var matches = _searchService.FindMatches(
    text,
    @"\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b",
    useRegex: true
);</code></pre>

                <h4>Replace</h4>
                <p>æ›¿æ¢æ–‡æœ¬ä¸­çš„æ‰€æœ‰åŒ¹é…é¡¹ã€‚</p>
                <pre><code class="language-csharp">var text = "Hello World, hello universe";
var result = _searchService.Replace(text, "hello", "Hi", caseSensitive: false);
Console.WriteLine(result);
// è¾“å‡º: Hi World, Hi universe

// æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢
var result = _searchService.Replace(
    "ç‰ˆæœ¬ 2.3.0 å‘å¸ƒäº 2025-11-15",
    @"\d+",
    "[NUM]",
    useRegex: true
);
// ç»“æœ: ç‰ˆæœ¬ [NUM].[NUM].[NUM] å‘å¸ƒäº [NUM]-[NUM]-[NUM]</code></pre>

                <!-- IWindowService -->
                <h2 id="iwindowservice">IWindowService</h2>
                <p>çª—å£ç®¡ç†æœåŠ¡ï¼Œæä¾›çª—å£ç½®é¡¶ã€é€æ˜åº¦ã€ç©¿é€æ¨¡å¼ç­‰åŠŸèƒ½ã€‚</p>

                <h3>æ¥å£å®šä¹‰</h3>
                <pre><code class="language-csharp">public interface IWindowService
{
    void SetTopmostMode(TopmostMode mode);
    TopmostMode GetCurrentTopmostMode();
    void SetClickThrough(bool enabled);
    bool IsClickThroughEnabled { get; }
    void SetWindowPosition(double x, double y);
    (double X, double Y) GetWindowPosition();
    void MoveToPresetPosition(string position);
    void SetWindowOpacity(double opacity);
    double GetWindowOpacity();
    void MinimizeToTray();
    void RestoreFromTray();
}</code></pre>

                <h3>æ–¹æ³•è¯¦æƒ…</h3>

                <h4>SetTopmostMode</h4>
                <p>è®¾ç½®çª—å£ç½®é¡¶æ¨¡å¼ã€‚</p>

                <table>
                    <thead>
                        <tr>
                            <th>æ¨¡å¼</th>
                            <th>è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>Normal</code></td>
                            <td>æ™®é€šæ¨¡å¼ï¼Œä¸ç½®é¡¶</td>
                        </tr>
                        <tr>
                            <td><code>Desktop</code></td>
                            <td>æ¡Œé¢å±‚é¢ç½®é¡¶ï¼ˆä½äºå…¶ä»–åº”ç”¨ï¼‰</td>
                        </tr>
                        <tr>
                            <td><code>Always</code></td>
                            <td>æ€»æ˜¯ç½®é¡¶ï¼ˆé«˜äºæ‰€æœ‰çª—å£ï¼‰</td>
                        </tr>
                    </tbody>
                </table>

                <pre><code class="language-csharp">// è®¾ç½®ä¸ºæ€»æ˜¯ç½®é¡¶
_windowService.SetTopmostMode(TopmostMode.Always);

// å–æ¶ˆç½®é¡¶
_windowService.SetTopmostMode(TopmostMode.Normal);</code></pre>

                <h4>SetClickThrough</h4>
                <p>å¯ç”¨æˆ–ç¦ç”¨ç©¿é€æ¨¡å¼ã€‚</p>
                <pre><code class="language-csharp">// å¯ç”¨ç©¿é€æ¨¡å¼
_windowService.SetClickThrough(true);

// ç¦ç”¨ç©¿é€æ¨¡å¼
_windowService.SetClickThrough(false);</code></pre>

                <blockquote>
                    <p><strong>ğŸ’¡ æç¤º</strong>ï¼šç©¿é€æ¨¡å¼ä¸‹ï¼Œé¼ æ ‡ç‚¹å‡»ä¼šç©¿é€çª—å£åˆ°ä¸‹å±‚åº”ç”¨ã€‚é€šè¿‡ Win32 API è®¾ç½®çª—å£æ‰©å±•æ ·å¼ <code>WS_EX_TRANSPARENT</code>ã€‚
                    </p>
                </blockquote>

                <h4>MoveToPresetPosition</h4>
                <p>ç§»åŠ¨åˆ°é¢„è®¾ä½ç½®ã€‚</p>

                <table>
                    <thead>
                        <tr>
                            <th>å‚æ•°å€¼</th>
                            <th>ä½ç½®</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>"top-left"</code></td>
                            <td>å·¦ä¸Šè§’</td>
                        </tr>
                        <tr>
                            <td><code>"top-right"</code></td>
                            <td>å³ä¸Šè§’</td>
                        </tr>
                        <tr>
                            <td><code>"bottom-left"</code></td>
                            <td>å·¦ä¸‹è§’</td>
                        </tr>
                        <tr>
                            <td><code>"bottom-right"</code></td>
                            <td>å³ä¸‹è§’</td>
                        </tr>
                        <tr>
                            <td><code>"center"</code></td>
                            <td>å±å¹•ä¸­å¿ƒ</td>
                        </tr>
                    </tbody>
                </table>

                <pre><code class="language-csharp">// ç§»åŠ¨åˆ°å³ä¸‹è§’
_windowService.MoveToPresetPosition("bottom-right");</code></pre>

                <h4>SetWindowOpacity</h4>
                <p>è®¾ç½®çª—å£é€æ˜åº¦ï¼ˆ0.0 - 1.0ï¼Œåº”ç”¨é™åˆ¶ 0.05 - 0.4ï¼‰ã€‚</p>
                <pre><code class="language-csharp">// è®¾ç½®ä¸º 20% é€æ˜åº¦
_windowService.SetWindowOpacity(0.2);</code></pre>

                <!-- ITrayService -->
                <h2 id="itrayservice">ITrayService</h2>
                <p>ç³»ç»Ÿæ‰˜ç›˜æœåŠ¡ï¼Œç®¡ç†æ‰˜ç›˜å›¾æ ‡å’Œèœå•ã€‚</p>

                <h3>æ¥å£å®šä¹‰</h3>
                <pre><code class="language-csharp">public interface ITrayService : IDisposable
{
    // äº‹ä»¶
    event EventHandler? TrayIconDoubleClick;
    event EventHandler? ShowHideWindowClick;
    event EventHandler? NewMemoClick;
    event EventHandler? ExitClick;
    event EventHandler&lt;TopmostMode&gt;? TopmostModeChangeClick;

    // æ–¹æ³•
    void Initialize();
    void Show();
    void Hide();
    void ShowBalloonTip(string title, string text, int timeout = 2000);
    void UpdateTopmostState(TopmostMode mode);
    void UpdateMenuTexts(Func&lt;string, string&gt; getLocalizedString);
}</code></pre>

                <h3>æ–¹æ³•è¯¦æƒ…</h3>

                <h4>ShowBalloonTip</h4>
                <p>æ˜¾ç¤ºæ°”æ³¡æç¤ºã€‚</p>
                <pre><code class="language-csharp">_trayService.ShowBalloonTip("ä¿å­˜æˆåŠŸ", "å¤‡å¿˜å½•å·²ä¿å­˜", 3000);</code></pre>

                <h4>UpdateMenuTexts</h4>
                <p>æ›´æ–°æ‰˜ç›˜èœå•æ–‡æœ¬ï¼ˆç”¨äºå¤šè¯­è¨€åˆ‡æ¢ï¼‰ã€‚</p>
                <pre><code class="language-csharp">_trayService.UpdateMenuTexts(key => _localizationService[key]);</code></pre>

                <!-- ILocalizationService -->
                <h2 id="ilocalizationservice">ILocalizationService</h2>
                <p>å¤šè¯­è¨€æœ¬åœ°åŒ–æœåŠ¡ã€‚</p>

                <h3>æ¥å£å®šä¹‰</h3>
                <pre><code class="language-csharp">public interface ILocalizationService
{
    string this[string key] { get; }
    CultureInfo CurrentCulture { get; }
    void ChangeLanguage(string cultureName);
    IEnumerable&lt;CultureInfo&gt; GetSupportedLanguages();
    event EventHandler&lt;LanguageChangedEventArgs&gt;? LanguageChanged;
}</code></pre>

                <h3>æ–¹æ³•è¯¦æƒ…</h3>

                <h4>è·å–æœ¬åœ°åŒ–å­—ç¬¦ä¸²</h4>
                <pre><code class="language-csharp">var saveText = _localizationService["Save"];
var cancelText = _localizationService["Cancel"];</code></pre>

                <h4>ChangeLanguage</h4>
                <p>åˆ‡æ¢è¯­è¨€ã€‚</p>

                <table>
                    <thead>
                        <tr>
                            <th>cultureName</th>
                            <th>è¯­è¨€</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>"zh-CN"</code></td>
                            <td>ç®€ä½“ä¸­æ–‡</td>
                        </tr>
                        <tr>
                            <td><code>"en-US"</code></td>
                            <td>è‹±è¯­</td>
                        </tr>
                        <tr>
                            <td><code>"zh-TW"</code></td>
                            <td>ç¹ä½“ä¸­æ–‡</td>
                        </tr>
                        <tr>
                            <td><code>"ja-JP"</code></td>
                            <td>æ—¥è¯­</td>
                        </tr>
                        <tr>
                            <td><code>"ko-KR"</code></td>
                            <td>éŸ©è¯­</td>
                        </tr>
                    </tbody>
                </table>

                <pre><code class="language-csharp">// åˆ‡æ¢åˆ°è‹±è¯­
_localizationService.ChangeLanguage("en-US");

// è®¢é˜…è¯­è¨€åˆ‡æ¢äº‹ä»¶
_localizationService.LanguageChanged += (s, e) =>
{
    Console.WriteLine($"è¯­è¨€å·²åˆ‡æ¢: {e.OldCulture} -> {e.NewCulture}");
    _trayService.UpdateMenuTexts(key => _localizationService[key]);
};</code></pre>

                <!-- ILogService -->
                <h2 id="ilogservice">ILogService</h2>
                <p>æ—¥å¿—è®°å½•æœåŠ¡ã€‚</p>

                <h3>æ¥å£å®šä¹‰</h3>
                <pre><code class="language-csharp">public interface ILogService
{
    void Log(string message, LogLevel level = LogLevel.Info);
    Task&lt;IEnumerable&lt;LogEntry&gt;&gt; GetLogsAsync(int count = 100);
    Task ClearLogsAsync();
}</code></pre>

                <h3>æ–¹æ³•è¯¦æƒ…</h3>
                <pre><code class="language-csharp">_logService.Log("åº”ç”¨å¯åŠ¨", LogLevel.Info);
_logService.Log("ä¿å­˜å¤±è´¥", LogLevel.Error);</code></pre>

                <!-- å®ç°ç±» -->
                <h2 id="implementations">å®ç°ç±»</h2>

                <table>
                    <thead>
                        <tr>
                            <th>æœåŠ¡</th>
                            <th>å®ç°ç±»</th>
                            <th>ä½ç½®</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ISettingsService</td>
                            <td>JsonSettingsService</td>
                            <td><code>DesktopMemo.Infrastructure.Services</code></td>
                        </tr>
                        <tr>
                            <td>IMemoSearchService</td>
                            <td>MemoSearchService</td>
                            <td><code>DesktopMemo.Infrastructure.Services</code></td>
                        </tr>
                        <tr>
                            <td>IWindowService</td>
                            <td>WindowService</td>
                            <td><code>DesktopMemo.Infrastructure.Services</code></td>
                        </tr>
                        <tr>
                            <td>ITrayService</td>
                            <td>TrayService</td>
                            <td><code>DesktopMemo.Infrastructure.Services</code></td>
                        </tr>
                        <tr>
                            <td>ILocalizationService</td>
                            <td>LocalizationService</td>
                            <td><code>DesktopMemo.App.Localization</code></td>
                        </tr>
                        <tr>
                            <td>ILogService</td>
                            <td>FileLogService</td>
                            <td><code>DesktopMemo.Infrastructure.Services</code></td>
                        </tr>
                    </tbody>
                </table>

                <hr>
                <h2>ç›¸å…³æ–‡æ¡£</h2>
                <ul>
                    <li><a href="repositories.html">ä»“å‚¨æ¥å£æ–‡æ¡£</a></li>
                    <li><a href="models.html">é¢†åŸŸæ¨¡å‹æ–‡æ¡£</a></li>
                    <li><a href="enums.html">æšä¸¾ç±»å‹æ–‡æ¡£</a></li>
                </ul>

                <hr>
                <p><strong>æœ€åæ›´æ–°</strong>: 2025-12-24</p>
            </div>
        </main>
    </div>

    <script src="../main.js"></script>
</body>

</html>