<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="DesktopMemo ä»“å‚¨æ¥å£ API æ–‡æ¡£ - IMemoRepository, ITodoRepository">
    <title>ä»“å‚¨æ¥å£ - DesktopMemo Docs</title>
    
    <script src="../theme-preload.js"></script>
    <link rel="stylesheet" href="../styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="layout">
        <nav class="sidebar">
            <div class="sidebar-logo">DesktopMemo</div>

            <h3>æ¦‚è§ˆ</h3>
            <ul>
                <li><a href="../index.html">é¦–é¡µ</a></li>
                <li><a href="../contributing.html">è´¡çŒ®æŒ‡å—</a></li>
                <li><a href="../mysql_integration.html">MySQL é›†æˆè§„èŒƒ</a></li>
            </ul>

            <h3>é¡¹ç›®æ¶æ„</h3>
            <ul>
                <li><a href="../project_structure/index.html">æ¶æ„é¦–é¡µ</a></li>
                <li><a href="../project_structure/architecture.html">01 æ¶æ„å›¾</a></li>
                <li><a href="../project_structure/modules.html">02 æ¨¡å—åˆ’åˆ†</a></li>
                <li><a href="../project_structure/tech_stack.html">03 æŠ€æœ¯æ ˆå’Œä¾èµ–</a></li>
                <li><a href="../project_structure/data_flow.html">04 æ•°æ®æµå’Œé€šä¿¡</a></li>
            </ul>

            <h3>API æ–‡æ¡£</h3>
            <ul>
                <li><a href="index.html">API æ¦‚è§ˆ</a></li>
                <li><a href="repositories.html" class="active">ä»“å‚¨æ¥å£</a></li>
                <li><a href="services.html">æœåŠ¡æ¥å£</a></li>
                <li><a href="models.html">é¢†åŸŸæ¨¡å‹</a></li>
                <li><a href="enums.html">æšä¸¾ç±»å‹</a></li>
            </ul>
        </nav>

        <main class="content">
            <div class="content-inner">
                <h1>ä»“å‚¨æ¥å£æ–‡æ¡£</h1>
                <p>ä»“å‚¨æ¥å£æä¾›æ•°æ®æŒä¹…åŒ–è®¿é—®çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œéµå¾ª <strong>Repository æ¨¡å¼</strong>ï¼Œéš”ç¦»æ•°æ®è®¿é—®é€»è¾‘ã€‚</p>

                <!-- IMemoRepository -->
                <h2 id="imemorepository">IMemoRepository</h2>
                <p>å¤‡å¿˜å½•æ•°æ®è®¿é—®æ¥å£ï¼Œæä¾›å¤‡å¿˜å½•çš„ CRUD æ“ä½œã€‚</p>

                <h3>æ¥å£å®šä¹‰</h3>
                <pre><code class="language-csharp">namespace DesktopMemo.Core.Contracts;

/// &lt;summary&gt;
/// å®šä¹‰å¤‡å¿˜å½•æŒä¹…åŒ–è®¿é—®çš„å¥‘çº¦ã€‚
/// &lt;/summary&gt;
public interface IMemoRepository
{
    Task&lt;IReadOnlyList&lt;Memo&gt;&gt; GetAllAsync(CancellationToken cancellationToken = default);
    Task&lt;Memo?&gt; GetByIdAsync(Guid id, CancellationToken cancellationToken = default);
    Task AddAsync(Memo memo, CancellationToken cancellationToken = default);
    Task UpdateAsync(Memo memo, CancellationToken cancellationToken = default);
    Task DeleteAsync(Guid id, CancellationToken cancellationToken = default);
}</code></pre>

                <h3>æ–¹æ³•è¯¦æƒ…</h3>

                <h4>GetAllAsync</h4>
                <p>è·å–æ‰€æœ‰å¤‡å¿˜å½•åˆ—è¡¨ã€‚</p>
                <pre><code class="language-csharp">Task&lt;IReadOnlyList&lt;Memo&gt;&gt; GetAllAsync(CancellationToken cancellationToken = default)</code></pre>

                <table>
                    <thead>
                        <tr>
                            <th>å‚æ•°</th>
                            <th>ç±»å‹</th>
                            <th>è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>cancellationToken</td>
                            <td><code>CancellationToken</code></td>
                            <td>å–æ¶ˆä»¤ç‰Œï¼Œç”¨äºå–æ¶ˆå¼‚æ­¥æ“ä½œ</td>
                        </tr>
                    </tbody>
                </table>

                <p><strong>è¿”å›å€¼</strong>ï¼š<code>Task&lt;IReadOnlyList&lt;Memo&gt;&gt;</code> - åŒ…å«æ‰€æœ‰å¤‡å¿˜å½•çš„åªè¯»åˆ—è¡¨</p>

                <pre><code class="language-csharp">var memos = await _memoRepository.GetAllAsync();
foreach (var memo in memos)
{
    Console.WriteLine($"{memo.DisplayTitle}: {memo.Preview}");
}</code></pre>

                <blockquote>
                    <p><strong>ğŸ’¡ æ³¨æ„</strong>ï¼šè¿”å›çš„åˆ—è¡¨æ˜¯åªè¯»çš„ï¼Œå¤‡å¿˜å½•æŒ‰æ›´æ–°æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰ï¼Œç½®é¡¶å¤‡å¿˜å½•ä¼šæ’åœ¨å‰é¢ã€‚</p>
                </blockquote>

                <h4>GetByIdAsync</h4>
                <p>æ ¹æ® ID è·å–æŒ‡å®šå¤‡å¿˜å½•ã€‚</p>
                <pre><code class="language-csharp">Task&lt;Memo?&gt; GetByIdAsync(Guid id, CancellationToken cancellationToken = default)</code></pre>

                <p><strong>è¿”å›å€¼</strong>ï¼šæ‰¾åˆ°çš„å¤‡å¿˜å½•ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å› <code>null</code></p>

                <pre><code class="language-csharp">var memo = await _memoRepository.GetByIdAsync(memoId);

if (memo != null)
{
    Console.WriteLine($"æ‰¾åˆ°å¤‡å¿˜å½•: {memo.DisplayTitle}");
}
else
{
    Console.WriteLine("å¤‡å¿˜å½•ä¸å­˜åœ¨");
}</code></pre>

                <h4>AddAsync</h4>
                <p>æ·»åŠ æ–°çš„å¤‡å¿˜å½•ã€‚</p>
                <pre><code class="language-csharp">Task AddAsync(Memo memo, CancellationToken cancellationToken = default)</code></pre>

                <pre><code class="language-csharp">var newMemo = Memo.CreateNew("", "å¤‡å¿˜å½•å†…å®¹");
await _memoRepository.AddAsync(newMemo);</code></pre>

                <blockquote>
                    <p><strong>âš ï¸ æ³¨æ„</strong>ï¼šå¤‡å¿˜å½•ä¼šåŒæ—¶ä¿å­˜åˆ° SQLite æ•°æ®åº“å’Œ Markdown æ–‡ä»¶ã€‚å¦‚æœ ID å·²å­˜åœ¨ï¼Œä¼šæŠ›å‡º
                        <code>InvalidOperationException</code>ã€‚</p>
                </blockquote>

                <p><strong>å¯èƒ½çš„å¼‚å¸¸</strong>ï¼š</p>
                <ul>
                    <li><code>InvalidOperationException</code> - å¤‡å¿˜å½• ID å·²å­˜åœ¨</li>
                    <li><code>IOException</code> - æ–‡ä»¶ç³»ç»Ÿæ“ä½œå¤±è´¥</li>
                    <li><code>UnauthorizedAccessException</code> - æ²¡æœ‰æ–‡ä»¶å†™å…¥æƒé™</li>
                </ul>

                <h4>UpdateAsync</h4>
                <p>æ›´æ–°ç°æœ‰å¤‡å¿˜å½•ã€‚</p>
                <pre><code class="language-csharp">Task UpdateAsync(Memo memo, CancellationToken cancellationToken = default)</code></pre>

                <pre><code class="language-csharp">var existingMemo = await _memoRepository.GetByIdAsync(memoId);
if (existingMemo != null)
{
    var updatedMemo = existingMemo.WithContent(
        "æ–°çš„å†…å®¹",
        DateTimeOffset.Now
    );
    await _memoRepository.UpdateAsync(updatedMemo);
}</code></pre>

                <p><strong>è‡ªåŠ¨å¤„ç†</strong>ï¼šä½¿ç”¨ Record çš„ <code>with</code> è¡¨è¾¾å¼åˆ›å»ºæ–°å¯¹è±¡ï¼Œç‰ˆæœ¬å·è‡ªåŠ¨é€’å¢ï¼ŒåŒæ­¥çŠ¶æ€è®¾ä¸º <code>PendingSync</code>ã€‚
                </p>

                <h4>DeleteAsync</h4>
                <p>åˆ é™¤æŒ‡å®šå¤‡å¿˜å½•ã€‚</p>
                <pre><code class="language-csharp">Task DeleteAsync(Guid id, CancellationToken cancellationToken = default)</code></pre>

                <pre><code class="language-csharp">await _memoRepository.DeleteAsync(memoId);</code></pre>

                <blockquote>
                    <p><strong>ğŸ’¡ è½¯åˆ é™¤</strong>ï¼šå®é™…ä¸Šæ˜¯è®¾ç½® <code>DeletedAt</code> å­—æ®µï¼Œæ•°æ®ä»ä¿ç•™ï¼ˆç”¨äºäº‘åŒæ­¥ï¼‰ã€‚å¹‚ç­‰æ“ä½œï¼Œé‡å¤åˆ é™¤ä¸ä¼šæŠ¥é”™ã€‚</p>
                </blockquote>

                <!-- ITodoRepository -->
                <h2 id="itodorepository">ITodoRepository</h2>
                <p>å¾…åŠäº‹é¡¹æ•°æ®è®¿é—®æ¥å£ï¼Œæä¾›å¾…åŠäº‹é¡¹çš„ CRUD æ“ä½œã€‚</p>

                <h3>æ¥å£å®šä¹‰</h3>
                <pre><code class="language-csharp">namespace DesktopMemo.Core.Contracts;

/// &lt;summary&gt;
/// å®šä¹‰å¾…åŠäº‹é¡¹æŒä¹…åŒ–è®¿é—®çš„å¥‘çº¦ã€‚
/// &lt;/summary&gt;
public interface ITodoRepository
{
    Task&lt;IReadOnlyList&lt;TodoItem&gt;&gt; GetAllAsync(CancellationToken cancellationToken = default);
    Task&lt;TodoItem?&gt; GetByIdAsync(Guid id, CancellationToken cancellationToken = default);
    Task AddAsync(TodoItem todoItem, CancellationToken cancellationToken = default);
    Task UpdateAsync(TodoItem todoItem, CancellationToken cancellationToken = default);
    Task DeleteAsync(Guid id, CancellationToken cancellationToken = default);
}</code></pre>

                <h3>æ–¹æ³•è¯¦æƒ…</h3>

                <h4>GetAllAsync</h4>
                <pre><code class="language-csharp">var todos = await _todoRepository.GetAllAsync();
var pendingTodos = todos.Where(t => !t.IsCompleted).ToList();
var completedTodos = todos.Where(t => t.IsCompleted).ToList();</code></pre>

                <p><strong>æ³¨æ„</strong>ï¼šè¿”å›çš„åˆ—è¡¨æŒ‰ <code>SortOrder</code> æ’åºï¼Œæœªå®Œæˆçš„å¾…åŠäº‹é¡¹æ’åœ¨å·²å®Œæˆçš„å‰é¢ã€‚</p>

                <h4>AddAsync</h4>
                <pre><code class="language-csharp">var newTodo = TodoItem.CreateNew("å®Œæˆé¡¹ç›®æ–‡æ¡£", sortOrder: 0);
await _todoRepository.AddAsync(newTodo);</code></pre>

                <h4>UpdateAsync</h4>
                <pre><code class="language-csharp">var todo = await _todoRepository.GetByIdAsync(todoId);
if (todo != null)
{
    // åˆ‡æ¢å®ŒæˆçŠ¶æ€
    var updatedTodo = todo.ToggleCompleted();
    await _todoRepository.UpdateAsync(updatedTodo);
}

// å…¶ä»–æ›´æ–°æ–¹æ³•
var updated = todo.WithContent("æ–°çš„å¾…åŠå†…å®¹");
var reordered = todo.WithSortOrder(5);</code></pre>

                <h4>DeleteAsync</h4>
                <pre><code class="language-csharp">await _todoRepository.DeleteAsync(todoId);</code></pre>

                <!-- å®ç°ç±» -->
                <h2 id="implementations">å®ç°ç±»</h2>

                <h3>SqliteIndexedMemoRepository</h3>
                <p>ä½äº <code>DesktopMemo.Infrastructure</code> é¡¹ç›®ä¸­ï¼Œä½¿ç”¨ SQLite + Markdown åŒå­˜å‚¨å®ç°ã€‚</p>

                <table>
                    <thead>
                        <tr>
                            <th>ç‰¹æ€§</th>
                            <th>è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>SQLite FTS5</td>
                            <td>å…¨æ–‡æœç´¢ç´¢å¼•</td>
                        </tr>
                        <tr>
                            <td>Markdown æ–‡ä»¶</td>
                            <td>å­˜å‚¨å®Œæ•´å†…å®¹</td>
                        </tr>
                        <tr>
                            <td>äº‹åŠ¡æ”¯æŒ</td>
                            <td>æ”¯æŒäº‹åŠ¡æ“ä½œ</td>
                        </tr>
                        <tr>
                            <td>ç‰ˆæœ¬æ§åˆ¶</td>
                            <td>è‡ªåŠ¨ç‰ˆæœ¬æ§åˆ¶</td>
                        </tr>
                    </tbody>
                </table>

                <p><strong>æ•°æ®å­˜å‚¨ä½ç½®</strong>ï¼š</p>
                <ul>
                    <li>æ•°æ®åº“ï¼š<code>.memodata/memos.db</code></li>
                    <li>æ–‡ä»¶ï¼š<code>.memodata/content/{memoId}.md</code></li>
                </ul>

                <h3>SqliteTodoRepository</h3>
                <p>ä½äº <code>DesktopMemo.Infrastructure</code> é¡¹ç›®ä¸­ï¼Œä½¿ç”¨ SQLite å­˜å‚¨ã€‚</p>

                <p><strong>æ•°æ®å­˜å‚¨ä½ç½®</strong>ï¼š<code>.memodata/todos.db</code></p>

                <!-- æœ€ä½³å®è·µ -->
                <h2 id="best-practices">æœ€ä½³å®è·µ</h2>

                <h3>1. ä½¿ç”¨å·¥å‚æ–¹æ³•åˆ›å»ºå®ä½“</h3>
                <pre><code class="language-csharp">// âœ… æ­£ç¡® - ä½¿ç”¨å·¥å‚æ–¹æ³•
var memo = Memo.CreateNew("æ ‡é¢˜", "å†…å®¹");
var todo = TodoItem.CreateNew("å¾…åŠå†…å®¹");

// âŒ é”™è¯¯ - æ‰‹åŠ¨æ„é€ ï¼ˆå®¹æ˜“é—æ¼å­—æ®µï¼‰
var memo = new Memo(Guid.NewGuid(), "æ ‡é¢˜", "å†…å®¹", ...);</code></pre>

                <h3>2. ä½¿ç”¨ with è¡¨è¾¾å¼æ›´æ–°</h3>
                <pre><code class="language-csharp">// âœ… æ­£ç¡® - ä½¿ç”¨ with è¡¨è¾¾å¼
var updated = existingMemo.WithContent("æ–°å†…å®¹", DateTimeOffset.Now);

// âŒ é”™è¯¯ - æ‰‹åŠ¨æ„é€ æ›´æ–°å¯¹è±¡
var updated = new Memo(existingMemo.Id, ...);</code></pre>

                <h3>3. é”™è¯¯å¤„ç†</h3>
                <pre><code class="language-csharp">try
{
    await _memoRepository.AddAsync(memo);
}
catch (InvalidOperationException ex)
{
    // å¤„ç†å¤‡å¿˜å½•å·²å­˜åœ¨
    Debug.WriteLine($"å¤‡å¿˜å½•å·²å­˜åœ¨: {ex.Message}");
}
catch (IOException ex)
{
    // å¤„ç†æ–‡ä»¶ç³»ç»Ÿé”™è¯¯
    Debug.WriteLine($"æ–‡ä»¶æ“ä½œå¤±è´¥: {ex.Message}");
}</code></pre>

                <h3>4. ä½¿ç”¨å–æ¶ˆä»¤ç‰Œ</h3>
                <pre><code class="language-csharp">public async Task LoadMemosAsync(CancellationToken cancellationToken)
{
    var memos = await _memoRepository.GetAllAsync(cancellationToken);
    // å¤„ç†æ•°æ®
}</code></pre>

                <!-- æ€§èƒ½è€ƒè™‘ -->
                <h2 id="performance">æ€§èƒ½è€ƒè™‘</h2>

                <h3>æ‰¹é‡æ“ä½œ</h3>
                <p>ç›®å‰æ¥å£ä¸æ”¯æŒæ‰¹é‡æ“ä½œï¼Œå¦‚éœ€æ‰¹é‡æ·»åŠ æˆ–æ›´æ–°ï¼Œéœ€è¦é€ä¸ªè°ƒç”¨ã€‚</p>
                <pre><code class="language-csharp">foreach (var memo in memos)
{
    await _memoRepository.AddAsync(memo);
}</code></pre>

                <h3>æŸ¥è¯¢ä¼˜åŒ–</h3>
                <ul>
                    <li><code>GetAllAsync</code> è¿”å›æ‰€æœ‰å¤‡å¿˜å½•ï¼Œå¤§æ•°æ®é‡æ—¶å¯èƒ½å½±å“æ€§èƒ½</li>
                    <li>è€ƒè™‘æ·»åŠ åˆ†é¡µæˆ–ç­›é€‰åŠŸèƒ½</li>
                </ul>

                <h3>å¹¶å‘æ§åˆ¶</h3>
                <ul>
                    <li>ä½¿ç”¨ç‰ˆæœ¬å·è¿›è¡Œä¹è§‚å¹¶å‘æ§åˆ¶</li>
                    <li>äº‘åŒæ­¥æ—¶æ£€æµ‹å†²çª</li>
                </ul>

                <hr>
                <h2>ç›¸å…³æ–‡æ¡£</h2>
                <ul>
                    <li><a href="models.html">é¢†åŸŸæ¨¡å‹æ–‡æ¡£</a></li>
                    <li><a href="services.html">æœåŠ¡æ¥å£æ–‡æ¡£</a></li>
                    <li><a href="../project_structure/data_flow.html">æ•°æ®æµå’Œé€šä¿¡</a></li>
                </ul>

                <hr>
                <p><strong>æœ€åæ›´æ–°</strong>: 2025-12-24</p>
            </div>
        </main>
    </div>

    <script src="../main.js"></script>
</body>

</html>