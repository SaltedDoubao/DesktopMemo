<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="DesktopMemo 领域模型 API 文档 - Memo, TodoItem, WindowSettings, LogEntry">
    <title>领域模型 - DesktopMemo Docs</title>
    
    <script src="../theme-preload.js"></script>
    <link rel="stylesheet" href="../styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="layout">
        <nav class="sidebar">
            <div class="sidebar-logo">DesktopMemo</div>

            <h3>概览</h3>
            <ul>
                <li><a href="../index.html">首页</a></li>
                <li><a href="../contributing.html">贡献指南</a></li>
                <li><a href="../mysql_integration.html">MySQL 集成规范</a></li>
            </ul>

            <h3>项目架构</h3>
            <ul>
                <li><a href="../project_structure/index.html">架构首页</a></li>
                <li><a href="../project_structure/architecture.html">01 架构图</a></li>
                <li><a href="../project_structure/modules.html">02 模块划分</a></li>
                <li><a href="../project_structure/tech_stack.html">03 技术栈和依赖</a></li>
                <li><a href="../project_structure/data_flow.html">04 数据流和通信</a></li>
            </ul>

            <h3>API 文档</h3>
            <ul>
                <li><a href="index.html">API 概览</a></li>
                <li><a href="repositories.html">仓储接口</a></li>
                <li><a href="services.html">服务接口</a></li>
                <li><a href="models.html" class="active">领域模型</a></li>
                <li><a href="enums.html">枚举类型</a></li>
            </ul>
        </nav>

        <main class="content">
            <div class="content-inner">
                <h1>领域模型文档</h1>
                <p>领域模型定义了应用的核心数据结构，采用 <strong>C# Record 类型</strong> 确保不可变性和线程安全。</p>

                <!-- Memo -->
                <h2 id="memo">Memo</h2>
                <p>备忘录领域模型，表示一条完整的备忘录数据。</p>

                <h3>定义</h3>
                <pre><code class="language-csharp">namespace DesktopMemo.Core.Models;

/// &lt;summary&gt;
/// 表示一条完整的备忘录数据。
/// &lt;/summary&gt;
public sealed record Memo(
    Guid Id,
    string Title,
    string Content,
    string Preview,
    DateTimeOffset CreatedAt,
    DateTimeOffset UpdatedAt,
    IReadOnlyList&lt;string&gt; Tags,
    bool IsPinned,
    int Version = 1,
    SyncStatus SyncStatus = SyncStatus.Synced,
    DateTimeOffset? DeletedAt = null)</code></pre>

                <h3>属性说明</h3>
                <table>
                    <thead>
                        <tr>
                            <th>属性</th>
                            <th>类型</th>
                            <th>说明</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Id</strong></td>
                            <td><code>Guid</code></td>
                            <td>备忘录的唯一标识符</td>
                        </tr>
                        <tr>
                            <td><strong>Title</strong></td>
                            <td><code>string</code></td>
                            <td>备忘录标题（保留字段，当前未使用）</td>
                        </tr>
                        <tr>
                            <td><strong>Content</strong></td>
                            <td><code>string</code></td>
                            <td>备忘录正文内容（Markdown 格式）</td>
                        </tr>
                        <tr>
                            <td><strong>Preview</strong></td>
                            <td><code>string</code></td>
                            <td>预览文本（前 120 字符或第一行）</td>
                        </tr>
                        <tr>
                            <td><strong>CreatedAt</strong></td>
                            <td><code>DateTimeOffset</code></td>
                            <td>创建时间</td>
                        </tr>
                        <tr>
                            <td><strong>UpdatedAt</strong></td>
                            <td><code>DateTimeOffset</code></td>
                            <td>最后更新时间</td>
                        </tr>
                        <tr>
                            <td><strong>Tags</strong></td>
                            <td><code>IReadOnlyList&lt;string&gt;</code></td>
                            <td>标签列表（保留字段，未来功能）</td>
                        </tr>
                        <tr>
                            <td><strong>IsPinned</strong></td>
                            <td><code>bool</code></td>
                            <td>是否置顶</td>
                        </tr>
                        <tr>
                            <td><strong>Version</strong></td>
                            <td><code>int</code></td>
                            <td>版本号（用于乐观并发控制）</td>
                        </tr>
                        <tr>
                            <td><strong>SyncStatus</strong></td>
                            <td><code>SyncStatus</code></td>
                            <td>同步状态（用于云同步功能）</td>
                        </tr>
                        <tr>
                            <td><strong>DeletedAt</strong></td>
                            <td><code>DateTimeOffset?</code></td>
                            <td>删除时间（软删除标记）</td>
                        </tr>
                    </tbody>
                </table>

                <h3>工厂方法: CreateNew</h3>
                <p>创建一个新的备忘录。</p>
                <pre><code class="language-csharp">public static Memo CreateNew(string title, string content)</code></pre>

                <h4>示例</h4>
                <pre><code class="language-csharp">var memo = Memo.CreateNew("", "我的第一条备忘录");</code></pre>

                <h4>特性</h4>
                <ul>
                    <li>自动生成 GUID</li>
                    <li>自动设置创建和更新时间为当前时间</li>
                    <li>自动生成预览文本</li>
                    <li>初始化为未置顶、未删除状态</li>
                    <li>版本号设为 1</li>
                    <li>同步状态设为 <code>Synced</code></li>
                </ul>

                <h3>更新方法</h3>
                <p>由于 Memo 是 Record 类型（不可变），所有更新操作都返回新的对象实例。</p>

                <h4>WithContent</h4>
                <p>更新备忘录内容。</p>
                <pre><code class="language-csharp">public Memo WithContent(string content, DateTimeOffset timestamp)

// 示例
var updated = memo.WithContent("更新后的内容", DateTimeOffset.Now);</code></pre>

                <p><strong>自动处理</strong>：更新 Content、重新生成 Preview、更新时间戳、版本号 +1、同步状态设为 <code>PendingSync</code></p>

                <h4>WithMetadata</h4>
                <p>更新备忘录元数据（标题、标签、置顶状态）。</p>
                <pre><code class="language-csharp">public Memo WithMetadata(string title, IReadOnlyList&lt;string&gt; tags, bool isPinned, DateTimeOffset timestamp)

// 示例
var tags = new List&lt;string&gt; { "工作", "重要" };
var updated = memo.WithMetadata("新标题", tags, isPinned: true, DateTimeOffset.Now);</code></pre>

                <h3>Preview 生成逻辑</h3>
                <ol>
                    <li>如果内容为空，返回空字符串</li>
                    <li>如果内容 ≤ 120 字符，返回完整内容</li>
                    <li>如果第一行 &lt; 120 字符，返回第一行</li>
                    <li>否则返回前 120 字符 + <code>...</code></li>
                </ol>

                <!-- TodoItem -->
                <h2 id="todoitem">TodoItem</h2>
                <p>待办事项领域模型。</p>

                <h3>定义</h3>
                <pre><code class="language-csharp">namespace DesktopMemo.Core.Models;

/// &lt;summary&gt;
/// 表示一个待办事项。
/// &lt;/summary&gt;
public sealed record TodoItem(
    Guid Id,
    string Content,
    bool IsCompleted,
    DateTimeOffset CreatedAt,
    DateTimeOffset UpdatedAt,
    int SortOrder,
    int Version = 1,
    SyncStatus SyncStatus = SyncStatus.Synced,
    DateTimeOffset? CompletedAt = null,
    DateTimeOffset? DeletedAt = null)</code></pre>

                <h3>属性说明</h3>
                <table>
                    <thead>
                        <tr>
                            <th>属性</th>
                            <th>类型</th>
                            <th>说明</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Id</strong></td>
                            <td><code>Guid</code></td>
                            <td>待办事项的唯一标识符</td>
                        </tr>
                        <tr>
                            <td><strong>Content</strong></td>
                            <td><code>string</code></td>
                            <td>待办事项内容</td>
                        </tr>
                        <tr>
                            <td><strong>IsCompleted</strong></td>
                            <td><code>bool</code></td>
                            <td>是否已完成</td>
                        </tr>
                        <tr>
                            <td><strong>SortOrder</strong></td>
                            <td><code>int</code></td>
                            <td>排序顺序（数字越小越靠前）</td>
                        </tr>
                        <tr>
                            <td><strong>CompletedAt</strong></td>
                            <td><code>DateTimeOffset?</code></td>
                            <td>完成时间</td>
                        </tr>
                    </tbody>
                </table>

                <h3>工厂方法: CreateNew</h3>
                <pre><code class="language-csharp">public static TodoItem CreateNew(string content, int sortOrder = 0)

// 示例
var todo = TodoItem.CreateNew("完成项目文档", sortOrder: 0);</code></pre>

                <h3>更新方法</h3>

                <h4>ToggleCompleted</h4>
                <p>切换完成状态。</p>
                <pre><code class="language-csharp">var completed = todo.ToggleCompleted(); // 未完成 → 已完成
var uncompleted = completed.ToggleCompleted(); // 已完成 → 未完成</code></pre>

                <p><strong>自动处理</strong>：</p>
                <ul>
                    <li>切换 <code>IsCompleted</code> 状态</li>
                    <li>如果变为已完成，设置 <code>CompletedAt</code> 为当前时间</li>
                    <li>如果变为未完成，清除 <code>CompletedAt</code></li>
                    <li>版本号 +1，同步状态设为 <code>PendingSync</code></li>
                </ul>

                <h4>WithContent / WithSortOrder</h4>
                <pre><code class="language-csharp">var updated = todo.WithContent("更新后的待办事项");
var reordered = todo.WithSortOrder(5);</code></pre>

                <!-- WindowSettings -->
                <h2 id="windowsettings">WindowSettings</h2>
                <p>窗口设置领域模型，保存用户的窗口和应用偏好设置。</p>

                <h3>定义</h3>
                <pre><code class="language-csharp">namespace DesktopMemo.Core.Models;

public sealed record WindowSettings(
    double Width,
    double Height,
    double Left,
    double Top,
    double Transparency,
    bool IsTopMost,
    bool IsDesktopMode,
    bool IsClickThrough,
    bool ShowDeleteConfirmation = true,
    bool ShowExitConfirmation = true,
    bool DefaultExitToTray = true,
    string PreferredLanguage = "zh-CN",
    string CurrentPage = "memo",
    bool TodoInputVisible = true,
    AppTheme Theme = AppTheme.Light,
    bool IsWindowPinned = false)</code></pre>

                <h3>属性说明</h3>
                <table>
                    <thead>
                        <tr>
                            <th>属性</th>
                            <th>类型</th>
                            <th>默认值</th>
                            <th>说明</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Width</strong></td>
                            <td><code>double</code></td>
                            <td>900</td>
                            <td>窗口宽度</td>
                        </tr>
                        <tr>
                            <td><strong>Height</strong></td>
                            <td><code>double</code></td>
                            <td>600</td>
                            <td>窗口高度</td>
                        </tr>
                        <tr>
                            <td><strong>Transparency</strong></td>
                            <td><code>double</code></td>
                            <td>0.05</td>
                            <td>透明度（0.05-0.4）</td>
                        </tr>
                        <tr>
                            <td><strong>IsTopMost</strong></td>
                            <td><code>bool</code></td>
                            <td>false</td>
                            <td>是否总是置顶</td>
                        </tr>
                        <tr>
                            <td><strong>IsDesktopMode</strong></td>
                            <td><code>bool</code></td>
                            <td>true</td>
                            <td>是否桌面模式置顶</td>
                        </tr>
                        <tr>
                            <td><strong>IsClickThrough</strong></td>
                            <td><code>bool</code></td>
                            <td>false</td>
                            <td>是否启用穿透模式</td>
                        </tr>
                        <tr>
                            <td><strong>Theme</strong></td>
                            <td><code>AppTheme</code></td>
                            <td>System</td>
                            <td>应用主题</td>
                        </tr>
                        <tr>
                            <td><strong>PreferredLanguage</strong></td>
                            <td><code>string</code></td>
                            <td>"zh-CN"</td>
                            <td>首选语言</td>
                        </tr>
                    </tbody>
                </table>

                <h3>默认设置</h3>
                <pre><code class="language-csharp">public static WindowSettings Default => new(
    900, 600,
    double.NaN, double.NaN,  // 窗口居中
    WindowConstants.DEFAULT_TRANSPARENCY,
    false, true, false,
    true, true, true,
    "zh-CN", "memo", true,
    AppTheme.System, false
);</code></pre>

                <h3>更新方法</h3>
                <pre><code class="language-csharp">// 更新位置
var newSettings = settings.WithLocation(100, 200);

// 更新大小
var newSettings = settings.WithSize(1200, 800);

// 使用 with 表达式更新多个属性
var newSettings = settings with
{
    Width = 1200,
    Height = 800,
    Theme = AppTheme.Dark,
    Transparency = 0.15
};</code></pre>

                <!-- LogEntry -->
                <h2 id="logentry">LogEntry</h2>
                <p>日志条目模型。</p>

                <h3>定义</h3>
                <pre><code class="language-csharp">public sealed record LogEntry(
    DateTimeOffset Timestamp,
    LogLevel Level,
    string Message,
    string? Exception = null)</code></pre>

                <h3>属性说明</h3>
                <table>
                    <thead>
                        <tr>
                            <th>属性</th>
                            <th>类型</th>
                            <th>说明</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Timestamp</strong></td>
                            <td><code>DateTimeOffset</code></td>
                            <td>日志时间戳</td>
                        </tr>
                        <tr>
                            <td><strong>Level</strong></td>
                            <td><code>LogLevel</code></td>
                            <td>日志级别</td>
                        </tr>
                        <tr>
                            <td><strong>Message</strong></td>
                            <td><code>string</code></td>
                            <td>日志消息</td>
                        </tr>
                        <tr>
                            <td><strong>Exception</strong></td>
                            <td><code>string?</code></td>
                            <td>异常信息（可选）</td>
                        </tr>
                    </tbody>
                </table>

                <!-- 最佳实践 -->
                <h2 id="best-practices">最佳实践</h2>

                <h3>1. 使用工厂方法创建</h3>
                <pre><code class="language-csharp">// ✅ 正确 - 使用工厂方法
var memo = Memo.CreateNew("", "内容");
var todo = TodoItem.CreateNew("待办事项");

// ❌ 错误 - 手动构造（容易出错）
var memo = new Memo(Guid.NewGuid(), "", "内容", ...);</code></pre>

                <h3>2. 使用 with 表达式更新</h3>
                <pre><code class="language-csharp">// ✅ 正确 - 使用 with 表达式或专用方法
var updated = memo.WithContent("新内容", DateTimeOffset.Now);
var updated2 = settings with { Theme = AppTheme.Dark };

// ❌ 错误 - 尝试直接修改（编译错误）
memo.Content = "新内容"; // 编译错误，Record 是不可变的</code></pre>

                <h3>3. 版本控制和冲突检测</h3>
                <pre><code class="language-csharp">public async Task UpdateMemoAsync(Memo updatedMemo)
{
    var current = await _repository.GetByIdAsync(updatedMemo.Id);

    if (current.Version != updatedMemo.Version)
    {
        throw new InvalidOperationException("版本冲突，数据已被其他操作修改");
    }

    await _repository.UpdateAsync(updatedMemo);
}</code></pre>

                <h3>4. 使用只读集合</h3>
                <pre><code class="language-csharp">// ✅ 正确 - 使用只读集合
var tags = new List&lt;string&gt; { "工作", "重要" }.AsReadOnly();
var memo = memo.WithMetadata("标题", tags, true, DateTimeOffset.Now);

// ❌ 错误 - 传递可变集合
var tags = new List&lt;string&gt; { "工作" };
// ...
tags.Add("紧急"); // 这可能会影响已创建的 memo</code></pre>

                <!-- 不可变性优势 -->
                <h2 id="immutability">不可变性的优势</h2>

                <h3>1. 线程安全</h3>
                <pre><code class="language-csharp">var memo = Memo.CreateNew("", "内容");

Task.Run(() => Console.WriteLine(memo.Content)); // 线程1
Task.Run(() => Console.WriteLine(memo.Content)); // 线程2
// 无需加锁，完全安全</code></pre>

                <h3>2. 历史追踪</h3>
                <pre><code class="language-csharp">var history = new List&lt;Memo&gt;();
var current = Memo.CreateNew("", "初始内容");
history.Add(current);

current = current.WithContent("版本2", DateTimeOffset.Now);
history.Add(current);

// 可以轻松访问任何历史版本
Console.WriteLine(history[0].Content); // 初始内容</code></pre>

                <h3>3. 简化状态管理</h3>
                <pre><code class="language-csharp">var darkSettings = settings with { Theme = AppTheme.Dark };

// 原始对象不受影响
Console.WriteLine(settings.Theme);     // Light
Console.WriteLine(darkSettings.Theme); // Dark</code></pre>

                <hr>
                <h2>相关文档</h2>
                <ul>
                    <li><a href="enums.html">枚举类型文档</a></li>
                    <li><a href="repositories.html">仓储接口文档</a></li>
                    <li><a href="services.html">服务接口文档</a></li>
                </ul>

                <hr>
                <p><strong>最后更新</strong>: 2025-12-24</p>
            </div>
        </main>
    </div>

    <script src="../main.js"></script>
</body>

</html>