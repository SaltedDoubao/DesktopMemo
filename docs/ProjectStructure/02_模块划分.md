# DesktopMemo æ¨¡å—åˆ’åˆ†è¯¦è§£

## 1. æ¨¡å—æ€»è§ˆ

æœ¬é¡¹ç›®æŒ‰ç…§**ä¸‰å±‚æ¶æ„**å’Œ**é¢†åŸŸé©±åŠ¨è®¾è®¡ (DDD)** æ€æƒ³è¿›è¡Œæ¨¡å—åˆ’åˆ†ï¼š

```mermaid
graph TB
    subgraph "DesktopMemo.App (è¡¨ç¤ºå±‚)"
        A1[Views æ¨¡å—]
        A2[ViewModels æ¨¡å—]
        A3[Localization æ¨¡å—]
        A4[Converters æ¨¡å—]
        A5[Resources æ¨¡å—]
    end

    subgraph "DesktopMemo.Core (é¢†åŸŸå±‚)"
        C1[Models æ¨¡å—]
        C2[Contracts æ¨¡å—]
        C3[Helpers æ¨¡å—]
        C4[Constants æ¨¡å—]
    end

    subgraph "DesktopMemo.Infrastructure (åŸºç¡€è®¾æ–½å±‚)"
        I1[Repositories æ¨¡å—]
        I2[Services æ¨¡å—]
    end

    A2 --> C2
    A2 --> C1
    I1 --> C2
    I1 --> C1
    I2 --> C2
    I2 --> C1

    style A1 fill:#e3f2fd
    style A2 fill:#e3f2fd
    style C1 fill:#fff3e0
    style C2 fill:#fff3e0
    style I1 fill:#e8f5e9
    style I2 fill:#e8f5e9
```

---

## 2. è¡¨ç¤ºå±‚ (DesktopMemo.App)

### 2.1 Views æ¨¡å—

**èŒè´£**: å®šä¹‰ç”¨æˆ·ç•Œé¢

**ä¸»è¦æ–‡ä»¶**:
- `MainWindow.xaml` / `MainWindow.xaml.cs` - ä¸»çª—å£
- ç”¨æˆ·æ§ä»¶ (å¦‚æœæœ‰)

**ç‰¹ç‚¹**:
- ä½¿ç”¨ WPF XAML è¯­æ³•
- é€šè¿‡æ•°æ®ç»‘å®šè¿æ¥åˆ° ViewModel
- ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
- è´Ÿè´£ UI äº‹ä»¶å¤„ç† (å¦‚çª—å£æ‹–æ‹½ã€æŒ‰é’®ç‚¹å‡»)

---

### 2.2 ViewModels æ¨¡å—

**èŒè´£**: å®ç°è¡¨ç¤ºé€»è¾‘ï¼Œè¿æ¥ View å’Œ Model

**æ ¸å¿ƒç±»**:

#### MainViewModel
- **è·¯å¾„**: `ViewModels/MainViewModel.cs`
- **èŒè´£**:
  - å¤‡å¿˜å½•åˆ—è¡¨ç®¡ç†
  - ç¼–è¾‘çŠ¶æ€ç®¡ç†
  - è®¾ç½®ç®¡ç†
  - çª—å£çŠ¶æ€æ§åˆ¶
- **å…³é”®å±æ€§**:
  - `Memos`: å¤‡å¿˜å½•é›†åˆ
  - `SelectedMemo`: å½“å‰é€‰ä¸­å¤‡å¿˜å½•
  - `EditorContent`: ç¼–è¾‘å™¨å†…å®¹
  - `WindowSettings`: çª—å£è®¾ç½®
  - `IsEditMode`: ç¼–è¾‘æ¨¡å¼æ ‡å¿—
- **å…³é”®å‘½ä»¤**:
  - `CreateMemoCommand`: åˆ›å»ºå¤‡å¿˜å½•
  - `DeleteMemoCommand`: åˆ é™¤å¤‡å¿˜å½•
  - `SaveMemoCommand`: ä¿å­˜å¤‡å¿˜å½•
  - `ToggleSettingsPanelCommand`: åˆ‡æ¢è®¾ç½®é¢æ¿

#### TodoListViewModel
- **è·¯å¾„**: `ViewModels/TodoListViewModel.cs`
- **èŒè´£**: TodoList åŠŸèƒ½ç®¡ç†
- **å…³é”®å±æ€§**:
  - `TodoItems`: ä»»åŠ¡é›†åˆ
  - `CompletedTodoItems`: å·²å®Œæˆä»»åŠ¡
- **å…³é”®å‘½ä»¤**:
  - `AddTodoCommand`: æ·»åŠ ä»»åŠ¡
  - `ToggleTodoCommand`: åˆ‡æ¢ä»»åŠ¡çŠ¶æ€
  - `DeleteTodoCommand`: åˆ é™¤ä»»åŠ¡

#### LogViewModel
- **è·¯å¾„**: `ViewModels/LogViewModel.cs`
- **èŒè´£**: æ—¥å¿—æŸ¥çœ‹å’Œè¿‡æ»¤
- **å…³é”®å±æ€§**:
  - `LogEntries`: æ—¥å¿—æ¡ç›®é›†åˆ
  - `FilterLevel`: æ—¥å¿—çº§åˆ«è¿‡æ»¤å™¨
- **å…³é”®åŠŸèƒ½**:
  - å®æ—¶åŠ è½½æ—¥å¿—
  - æŒ‰çº§åˆ«è¿‡æ»¤
  - æ¸…ç©ºæ—¥å¿—

**æŠ€æœ¯ç‰¹ç‚¹**:
- ç»§æ‰¿ `ObservableObject` (CommunityToolkit.Mvvm)
- ä½¿ç”¨ `[ObservableProperty]` è‡ªåŠ¨ç”Ÿæˆå±æ€§é€šçŸ¥
- ä½¿ç”¨ `[RelayCommand]` è‡ªåŠ¨ç”Ÿæˆå‘½ä»¤
- é€šè¿‡ä¾èµ–æ³¨å…¥è·å–æœåŠ¡

---

### 2.3 Localization æ¨¡å—

**èŒè´£**: å¤šè¯­è¨€æ”¯æŒ

**ä¸»è¦ç»„ä»¶**:
- `LocalizationService.cs` - æœ¬åœ°åŒ–æœåŠ¡å®ç°
- `Resources/` - è¯­è¨€èµ„æºæ–‡ä»¶ (å¦‚ `Strings.zh-CN.json`, `Strings.en-US.json`)

**æ”¯æŒçš„è¯­è¨€**:
- ç®€ä½“ä¸­æ–‡ (zh-CN)
- English (en-US)
- æ›´å¤šè¯­è¨€å¯æ‰©å±•

**å·¥ä½œåŸç†**:
- ä» JSON æ–‡ä»¶åŠ è½½ç¿»è¯‘
- é€šè¿‡ `ILocalizationService` æ¥å£æä¾›ç¿»è¯‘
- æ”¯æŒè¿è¡Œæ—¶åˆ‡æ¢è¯­è¨€

---

### 2.4 Converters æ¨¡å—

**èŒè´£**: å€¼è½¬æ¢å™¨ (ç”¨äºæ•°æ®ç»‘å®š)

**å…¸å‹è½¬æ¢å™¨**:
- `BooleanToVisibilityConverter` - å¸ƒå°”å€¼è½¬å¯è§æ€§
- `InverseBooleanConverter` - å¸ƒå°”å€¼å–å
- `DateTimeToStringConverter` - æ—¥æœŸæ—¶é—´æ ¼å¼åŒ–

---

### 2.5 Resources æ¨¡å—

**èŒè´£**: ä¸»é¢˜ã€æ ·å¼ã€å›¾æ ‡ç­‰èµ„æº

**ä¸»è¦æ–‡ä»¶**:
- `App.xaml` - å…¨å±€èµ„æºå­—å…¸
- `Resources/Themes/` - ä¸»é¢˜å®šä¹‰ (æµ…è‰²ã€æ·±è‰²)
- `../images/logo.ico` - åº”ç”¨å›¾æ ‡

---

## 3. é¢†åŸŸå±‚ (DesktopMemo.Core)

### 3.1 Models æ¨¡å—

**èŒè´£**: å®šä¹‰ä¸šåŠ¡å®ä½“

**æ ¸å¿ƒå®ä½“**:

#### Memo (å¤‡å¿˜å½•)
```csharp
public sealed record Memo(
    Guid Id,
    string Title,
    string Content,
    string Preview,
    DateTimeOffset CreatedAt,
    DateTimeOffset UpdatedAt,
    IReadOnlyList<string> Tags,
    bool IsPinned,
    int Version,
    SyncStatus SyncStatus,
    DateTimeOffset? DeletedAt
)
```
- **ä¸å¯å˜å¯¹è±¡** (ä½¿ç”¨ `record` å…³é”®å­—)
- **æ–¹æ³•**: `CreateNew()`, `WithContent()`, `WithMetadata()`
- **è®¡ç®—å±æ€§**: `DisplayTitle` (æ™ºèƒ½æå–æ ‡é¢˜)

#### TodoItem (å¾…åŠä»»åŠ¡)
```csharp
public record TodoItem(
    Guid Id,
    string Content,
    bool IsCompleted,
    DateTimeOffset CreatedAt,
    DateTimeOffset? CompletedAt
)
```

#### WindowSettings (çª—å£è®¾ç½®)
- çª—å£ä½ç½®ã€å¤§å°
- é€æ˜åº¦ã€ç½®é¡¶æ¨¡å¼
- ä¸»é¢˜ã€è¯­è¨€

#### LogEntry (æ—¥å¿—æ¡ç›®)
- æ—¥å¿—çº§åˆ« (Debug, Info, Warning, Error)
- æ—¶é—´æˆ³
- æ¥æºã€æ¶ˆæ¯ã€å¼‚å¸¸

**æšä¸¾ç±»å‹**:
- `AppTheme`: ä¸»é¢˜ (Light, Dark, Auto)
- `SyncStatus`: åŒæ­¥çŠ¶æ€ (Synced, PendingSync, Conflict)
- `LogLevel`: æ—¥å¿—çº§åˆ«

---

### 3.2 Contracts æ¨¡å—

**èŒè´£**: å®šä¹‰æ¥å£å¥‘çº¦

**æ ¸å¿ƒæ¥å£**:

#### æ•°æ®è®¿é—®æ¥å£
- `IMemoRepository` - å¤‡å¿˜å½•ä»“å‚¨
  ```csharp
  Task<IReadOnlyList<Memo>> GetAllAsync()
  Task<Memo?> GetByIdAsync(Guid id)
  Task AddAsync(Memo memo)
  Task UpdateAsync(Memo memo)
  Task DeleteAsync(Guid id)
  ```

- `ITodoRepository` - å¾…åŠä»»åŠ¡ä»“å‚¨
- `ISettingsService` - è®¾ç½®æœåŠ¡
  ```csharp
  Task<WindowSettings> LoadAsync()
  Task SaveAsync(WindowSettings settings)
  ```

#### ä¸šåŠ¡æœåŠ¡æ¥å£
- `IMemoSearchService` - æœç´¢æœåŠ¡
  ```csharp
  Task<IReadOnlyList<Memo>> SearchAsync(string keyword)
  Task<IReadOnlyList<Memo>> GetByTagAsync(string tag)
  ```

- `ILogService` - æ—¥å¿—æœåŠ¡
  ```csharp
  void Debug(string source, string message)
  void Info(string source, string message)
  void Warning(string source, string message)
  void Error(string source, string message, Exception? ex)
  ```

#### UI æœåŠ¡æ¥å£
- `IWindowService` - çª—å£ç®¡ç†æœåŠ¡
  ```csharp
  void SetTopmost(bool topmost)
  void SetTransparency(double opacity)
  void SetClickThrough(bool enabled)
  ```

- `ITrayService` - ç³»ç»Ÿæ‰˜ç›˜æœåŠ¡
  ```csharp
  void Initialize()
  void Show()
  void Hide()
  ```

- `ILocalizationService` - æœ¬åœ°åŒ–æœåŠ¡
  ```csharp
  string GetString(string key)
  void ChangeLanguage(string languageCode)
  ```

---

### 3.3 Helpers æ¨¡å—

**èŒè´£**: è¾…åŠ©å·¥å…·ç±»

**æ ¸å¿ƒå·¥å…·**:

#### DebounceHelper
- **ç”¨é€”**: é˜²æŠ–åŠ¨ (å»¶è¿Ÿæ‰§è¡Œ)
- **åœºæ™¯**: è®¾ç½®ä¿å­˜ã€æœç´¢è¾“å…¥
- **ç¤ºä¾‹**:
  ```csharp
  _debouncer.Debounce(500, async () => await SaveSettingsAsync());
  ```

#### TransparencyHelper
- **ç”¨é€”**: è®¡ç®—çª—å£é€æ˜åº¦
- **åŠŸèƒ½**: ç™¾åˆ†æ¯” â†” ä¸é€æ˜åº¦å€¼è½¬æ¢

---

### 3.4 Constants æ¨¡å—

**èŒè´£**: å®šä¹‰ç³»ç»Ÿå¸¸é‡

**ä¸»è¦å¸¸é‡**:
- `WindowConstants` - çª—å£ç›¸å…³å¸¸é‡
  - é»˜è®¤å®½åº¦ã€é«˜åº¦
  - æœ€å°å®½åº¦ã€é«˜åº¦
  - ç½®é¡¶æ¨¡å¼æšä¸¾

---

## 4. åŸºç¡€è®¾æ–½å±‚ (DesktopMemo.Infrastructure)

### 4.1 Repositories æ¨¡å—

**èŒè´£**: æ•°æ®è®¿é—®å®ç°

**æ ¸å¿ƒå®ç°**:

#### SqliteIndexedMemoRepository
- **è·¯å¾„**: `Repositories/SqliteIndexedMemoRepository.cs`
- **å®ç°æ¥å£**: `IMemoRepository`
- **å­˜å‚¨æ–¹å¼**:
  - **Markdown æ–‡ä»¶**: å®Œæ•´å†…å®¹
    - æ ¼å¼: YAML Front Matter + Markdown Body
    - ä½ç½®: `.memodata/memos/{id}.md`
  - **SQLite ç´¢å¼•**: å…ƒæ•°æ®
    - è¡¨: `memos`
    - å­—æ®µ: id, title, preview, created_at, updated_at, tags, is_pinned
- **å…³é”®æŠ€æœ¯**:
  - ä½¿ç”¨ Dapper æŸ¥è¯¢ SQLite
  - ä½¿ç”¨ File I/O è¯»å†™ Markdown
  - åŒå†™ç­–ç•¥ (å…ˆå†™æ–‡ä»¶ï¼Œåå†™ç´¢å¼•)

#### SqliteTodoRepository
- **è·¯å¾„**: `Repositories/SqliteTodoRepository.cs`
- **å®ç°æ¥å£**: `ITodoRepository`
- **å­˜å‚¨æ–¹å¼**: å®Œå…¨ä½¿ç”¨ SQLite
  - è¡¨: `todos`
  - æ”¯æŒäº‹åŠ¡

#### JsonSettingsService
- **è·¯å¾„**: `Services/JsonSettingsService.cs`
- **å®ç°æ¥å£**: `ISettingsService`
- **å­˜å‚¨æ–¹å¼**: JSON æ–‡ä»¶ (`.memodata/settings.json`)
- **åºåˆ—åŒ–**: `System.Text.Json`

---

### 4.2 Services æ¨¡å—

**èŒè´£**: ä¸šåŠ¡æœåŠ¡å®ç°

**æ ¸å¿ƒæœåŠ¡**:

#### MemoSearchService
- **è·¯å¾„**: `Services/MemoSearchService.cs`
- **å®ç°æ¥å£**: `IMemoSearchService`
- **åŠŸèƒ½**:
  - å…¨æ–‡æœç´¢ (æ ‡é¢˜ + å†…å®¹)
  - æ ‡ç­¾ç­›é€‰
  - ç»„åˆæŸ¥è¯¢ (SQLite FTS æˆ– LIKE)

#### FileLogService
- **è·¯å¾„**: `Services/FileLogService.cs`
- **å®ç°æ¥å£**: `ILogService`
- **åŠŸèƒ½**:
  - å†™å…¥æ—¥å¿—åˆ°æ–‡ä»¶
  - æŒ‰æ—¥æœŸæ»šåŠ¨ (`.memodata/logs/app-2025-11-15.log`)
  - å¼‚æ­¥å†™å…¥ (é¿å…é˜»å¡ UI)

#### WindowService
- **è·¯å¾„**: `Services/WindowService.cs`
- **å®ç°æ¥å£**: `IWindowService`
- **åŠŸèƒ½**:
  - è®¾ç½®çª—å£ç½®é¡¶ (è°ƒç”¨ Win32 API `SetWindowPos`)
  - è®¾ç½®çª—å£é€æ˜åº¦ (WPF `Opacity` å±æ€§)
  - è®¾ç½®ç‚¹å‡»ç©¿é€ (Win32 API `WS_EX_TRANSPARENT`)

#### TrayService
- **è·¯å¾„**: `Services/TrayService.cs`
- **å®ç°æ¥å£**: `ITrayService`
- **åŠŸèƒ½**:
  - åˆ›å»ºç³»ç»Ÿæ‰˜ç›˜å›¾æ ‡ (ä½¿ç”¨ `System.Windows.Forms.NotifyIcon`)
  - æ‰˜ç›˜èœå• (æ˜¾ç¤º/éšè—çª—å£ã€é€€å‡ºåº”ç”¨)
  - åŒå‡»æ‰˜ç›˜å›¾æ ‡æ¢å¤çª—å£

#### æ•°æ®è¿ç§»æœåŠ¡
- **MemoMigrationService**: å†å²ç‰ˆæœ¬å¤‡å¿˜å½•æ ¼å¼è¿ç§»
- **TodoMigrationService**: JSON â†’ SQLite è¿ç§»
- **MemoMetadataMigrationService**: index.json â†’ SQLite ç´¢å¼•è¿ç§»

**ç‰¹ç‚¹**:
- å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹å¹¶æ‰§è¡Œ
- è¿ç§»æˆåŠŸåä¿ç•™æ—§æ–‡ä»¶ä½œä¸ºå¤‡ä»½
- è®°å½•è¿ç§»æ—¥å¿—

---

## 5. æ¨¡å—é—´é€šä¿¡

```mermaid
sequenceDiagram
    participant UI as MainWindow (View)
    participant VM as MainViewModel
    participant Repo as SqliteIndexedMemoRepository
    participant FS as File System
    participant DB as SQLite Database

    UI->>VM: ç”¨æˆ·ç‚¹å‡» "ä¿å­˜"
    VM->>VM: æ‰§è¡Œ SaveMemoCommand
    VM->>Repo: UpdateAsync(memo)
    Repo->>FS: å†™å…¥ Markdown æ–‡ä»¶
    Repo->>DB: æ›´æ–° SQLite ç´¢å¼•
    DB-->>Repo: æˆåŠŸ
    Repo-->>VM: æˆåŠŸ
    VM->>VM: æ›´æ–° Memos é›†åˆ
    VM-->>UI: å±æ€§é€šçŸ¥ (INotifyPropertyChanged)
    UI->>UI: åˆ·æ–° UI
```

---

## 6. æ¨¡å—ä¾èµ–å…³ç³»

### ä¾èµ–è§„åˆ™
1. **è¡¨ç¤ºå±‚** å¯ä»¥ä¾èµ– **é¢†åŸŸå±‚** å’Œ **åŸºç¡€è®¾æ–½å±‚**
2. **åŸºç¡€è®¾æ–½å±‚** å¯ä»¥ä¾èµ– **é¢†åŸŸå±‚**
3. **é¢†åŸŸå±‚** ä¸ä¾èµ–ä»»ä½•å…¶ä»–å±‚ (çº¯ POCO)

### ä¾èµ–å›¾
```mermaid
graph LR
    App[DesktopMemo.App] --> Core[DesktopMemo.Core]
    App --> Infra[DesktopMemo.Infrastructure]
    Infra --> Core

    style Core fill:#fff3e0
    style Infra fill:#e8f5e9
    style App fill:#e3f2fd
```

---

## 7. æ¨¡å—èŒè´£çŸ©é˜µ

| æ¨¡å— | åˆ›å»º | è¯»å– | æ›´æ–° | åˆ é™¤ | æœç´¢ | æ¸²æŸ“ |
|------|------|------|------|------|------|------|
| **ViewModels** | âœ… | âœ… | âœ… | âœ… | âœ… | âŒ |
| **Views** | âŒ | âŒ | âŒ | âŒ | âŒ | âœ… |
| **Repositories** | âœ… | âœ… | âœ… | âœ… | âœ… | âŒ |
| **Services** | âŒ | âœ… | âŒ | âŒ | âœ… | âŒ |
| **Models** | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ |

---

## 8. æ¨¡å—æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°åŠŸèƒ½çš„æ­¥éª¤

#### ç¤ºä¾‹: æ·»åŠ  "å¤‡å¿˜å½•åˆ†ç±»" åŠŸèƒ½

1. **å®šä¹‰é¢†åŸŸæ¨¡å‹** (Core/Models)
   ```csharp
   public record Category(Guid Id, string Name, string Color);
   ```

2. **å®šä¹‰æ¥å£** (Core/Contracts)
   ```csharp
   public interface ICategoryRepository
   {
       Task<IReadOnlyList<Category>> GetAllAsync();
       Task AddAsync(Category category);
   }
   ```

3. **å®ç°ä»“å‚¨** (Infrastructure/Repositories)
   ```csharp
   public class SqliteCategoryRepository : ICategoryRepository
   {
       // å®ç°æ¥å£æ–¹æ³•
   }
   ```

4. **æ³¨å†ŒæœåŠ¡** (App.xaml.cs)
   ```csharp
   services.AddSingleton<ICategoryRepository, SqliteCategoryRepository>();
   ```

5. **æ·»åŠ  ViewModel** (App/ViewModels)
   ```csharp
   public partial class CategoryViewModel : ObservableObject
   {
       private readonly ICategoryRepository _categoryRepository;
       // ...
   }
   ```

6. **åˆ›å»ºè§†å›¾** (App/Views)
   - æ·»åŠ  `CategoryManagementView.xaml`

---

## 9. æ¨¡å—ç»´æŠ¤å»ºè®®

### æœ€æ ¸å¿ƒæ¨¡å— â­
1. **MainViewModel** - åº”ç”¨æ ¸å¿ƒé€»è¾‘
2. **SqliteIndexedMemoRepository** - æ•°æ®å­˜å‚¨
3. **App.xaml.cs** - ä¾èµ–æ³¨å…¥é…ç½®

### éœ€è¦é‡ç‚¹æµ‹è¯•çš„æ¨¡å— ğŸ§ª
1. **Repositories** - æ•°æ®æ­£ç¡®æ€§
2. **Migration Services** - å‡çº§å…¼å®¹æ€§
3. **WindowService** - è·¨ Windows ç‰ˆæœ¬å…¼å®¹æ€§

### æ€§èƒ½æ•æ„Ÿæ¨¡å— âš¡
1. **MemoSearchService** - å¤§é‡å¤‡å¿˜å½•æ—¶çš„æœç´¢æ€§èƒ½
2. **FileLogService** - æ—¥å¿—å†™å…¥ä¸åº”é˜»å¡ UI
3. **MainViewModel** - é˜²æŠ–åŠ¨è®¾ç½®ä¿å­˜

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-11-15
**ç»´æŠ¤è€…**: é¡¹ç›®å¼€å‘å›¢é˜Ÿ
